//Define region of interest
// Create a geometry representing an export region (near Jaisalmer).
var geometry = /* color: #00ffff */ee.Geometry.Polygon(
        [[[70.75894231129689, 25.54670603185635],
          [71.17642278004689, 24.85085434858454],
          [71.82461613942189, 25.139617951574408],
          [72.51675481129689, 25.278777563996034],
          [73.37368840504689, 25.487217850980564],
          [73.75820988942189, 26.04128869562203],
          [74.16470403004689, 26.53379405484255],
          [74.64810246754689, 26.91648844655037],
          [75.17544621754689, 27.31741344387549],
          [75.81265324879689, 28.318214077961912],
          [75.40615910817189, 28.58867210968267],
          [75.28530949879689, 29.012273919059222],
          [75.02163762379689, 29.041093051127362],
          [74.71402043629689, 29.319262408067498],
          [74.60415715504689, 29.127502148519604],
          [74.37344426442189, 29.127502148519604],
          [73.64834660817189, 29.165882911008435],
          [72.36294621754689, 28.694733850850596],
          [72.14321965504689, 28.221454556198225],
          [71.91250676442189, 27.90152644473874],
          [71.42910832692189, 27.823824965717016],
          [71.05557317067189, 27.746067833136603],
          [70.70401067067189, 27.648793312241942],
          [70.49527043629689, 27.920943106548464],
          [70.31948918629689, 27.852969547792586],
          [69.89102238942189, 27.40522860895214],
          [69.61636418629689, 26.96545856024489],
          [69.83609074879689, 26.710582139385473],
          [70.22061223317189, 26.671319537640652],
          [70.16568059254689, 26.42562252048915],
          [70.27554387379689, 25.814036981332112],
          [70.70401067067189, 25.744786582647283]]]); 

var collection = ee.ImageCollection("LANDSAT/LE07/C01/T1")
  .filterDate('2003-01-01', '2003-05-01')
  .filterBounds(geometry);

// Also filter the collection by the IMAGE_QUALITY property.
var filtered = collection
  .filterMetadata('IMAGE_QUALITY', 'equals', 9);

// Create two composites to check the effect of filtering by IMAGE_QUALITY.
var goodComposite = ee.Algorithms.Landsat.simpleComposite(filtered, 75, 3);

// Compute the Normalized Difference Vegetation Index (NDVI).
var nir = goodComposite.select('B5');
var red = goodComposite.select('B4');
var ndvi = nir.subtract(red).divide(nir.add(red)).rename('NDVI');

// Display the result.
var ndviParams = {min: -1, max: 1, palette: ['green', 'white', 'blue']}; //colors maybe need playing with

// Add PC band
var Panchromatic = goodComposite.select(['B8']);

//////////////////////////Edge Detection///////////////////////

// Detect edges in the panchromatic composite.
var canny = ee.Algorithms.CannyEdgeDetector(Panchromatic, 12, 2);


////////////////////
// Detect edges in the NDVI composite.
var canny1 = ee.Algorithms.CannyEdgeDetector(ndvi, .1, 5.5);


// Create buffers around NDVi and Pan bands
var bufferSize = 80 // in meters
var edgeBuffer_NDVI = canny1.focal_max(bufferSize, 'square', 'meters'); 

var bufferSize = 65 // in meters
var edgeBuffer_Pan = canny.focal_max(bufferSize, 'square', 'meters'); 



//Overview
Map.setCenter(72.2595654822021, 27.14173618881201, 7);

///////////////Training Data
var farms = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.27357662375698, 27.148903012828047],
                  [72.27477825339565, 27.150344566133036],
                  [72.27402723487148, 27.15088872380317],
                  [72.27250374015102, 27.149599925026347]]]),
            {
              "farm": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.2771278684927, 27.146134414584917],
                  [72.2782436674429, 27.14792923781859],
                  [72.27719224150906, 27.14843522001015],
                  [72.2762266462637, 27.146678592759603]]]),
            {
              "farm": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.25751035452572, 27.142812289233195],
                  [72.25686662436215, 27.141762082114834],
                  [72.25777857542721, 27.14138018617049],
                  [72.2586046958038, 27.141723892579122],
                  [72.25899093390194, 27.142344470917557]]]),
            {
              "farm": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.24956028700558, 27.143203727543572],
                  [72.24893801451412, 27.142564059350402],
                  [72.24994652510372, 27.141790724258044],
                  [72.25079410315243, 27.14253541740535]]]),
            {
              "farm": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.2474459215124, 27.137174697610916],
                  [72.2472849889715, 27.136248559683086],
                  [72.2481862112005, 27.135923932201624],
                  [72.24881921252802, 27.136601829694747],
                  [72.24756393870905, 27.13735610517234]]]),
            {
              "farm": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.23227801811822, 27.13162555356028],
                  [72.23165574562677, 27.130947625893693],
                  [72.23259988320001, 27.130470209577528],
                  [72.23323288452752, 27.13109085039104]]]),
            {
              "farm": 1,
              "system:index": "5"
            })]);


var not_farms = ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.18645203758035, 27.083737560130473],
                  [72.22893822837625, 27.085571593262667],
                  [72.23726380515848, 27.09604029084492],
                  [72.23348725486551, 27.116592769479915],
                  [72.21323121238504, 27.119419395077905],
                  [72.19271767783914, 27.106049590115685],
                  [72.1819030110911, 27.09046220149958]]]),
            {
              "farm": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.28988182550768, 27.183542842315603],
                  [72.27563385322719, 27.175067570145522],
                  [72.28232868358339, 27.164300755827433],
                  [72.28709230760103, 27.15834440885502],
                  [72.29769246087608, 27.164453483848074],
                  [72.30520295873453, 27.17170748315704],
                  [72.29788612110929, 27.1809085675156]]]),
            {
              "farm": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.06466409104985, 26.148520011478727],
                  [71.03960153001469, 26.150292063402716],
                  [71.02629778308051, 26.134759760016713],
                  [71.04910218640646, 26.12281863323826],
                  [71.06746995374044, 26.121662678311566],
                  [71.07608398769969, 26.128110227300972],
                  [71.0753115115034, 26.136355333798694]]]),
            {
              "farm": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.19591236345809, 28.13393991645888],
                  [73.18243694536727, 28.145595480092712],
                  [73.16252422564071, 28.144535935803457],
                  [73.1511945747618, 28.135453697672116],
                  [73.15295134314488, 28.108585772804112],
                  [73.18299208411167, 28.10347539500948],
                  [73.19402132758091, 28.113960870431985],
                  [73.2045809693675, 28.124921631069732]]]),
            {
              "farm": 0,
              "system:index": "3"
            })]); 


//////Second try, above not-farms too big
var not_farms2 = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.36834036779055, 27.100934445418922],
                  [72.37722384404788, 27.10101085233305],
                  [72.37730967473635, 27.108422075152703],
                  [72.36958491277346, 27.108001864300547]]]),
            {
              "farm": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.40081049751313, 27.47009674660307],
                  [71.39917971443208, 27.466669789217246],
                  [71.41793371986421, 27.458178091285806],
                  [71.42505766700776, 27.46579399412369],
                  [71.41248347114595, 27.47287631154563]]]),
            {
              "farm": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.24314393624593, 27.343626855374882],
                  [71.23584832772542, 27.33893795729859],
                  [71.2403115235262, 27.334935082459598],
                  [71.25056829079915, 27.343398133242626]]]),
            {
              "farm": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.11338175148785, 27.183129382521972],
                  [71.1109784922105, 27.180819747870917],
                  [71.11393965096295, 27.178605507780794],
                  [71.11604250283062, 27.180514338057048]]]),
            {
              "farm": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.15631228876236, 27.156330778539413],
                  [71.15472442102555, 27.149991963408848],
                  [71.16506701898697, 27.1492282264649]]]),
            {
              "farm": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[70.95904077965952, 26.9536552983014],
                  [70.95573629815317, 26.951178350574736],
                  [70.96044625718332, 26.949332558757664],
                  [70.96259202439524, 26.952536374989922]]]),
            {
              "farm": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[70.95645460372032, 26.85389943158324],
                  [70.95451268439353, 26.85573721225055],
                  [70.95233473067344, 26.854550315649757],
                  [70.95678719763816, 26.852406212814103]]]),
            {
              "farm": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.80754817128127, 25.479850499296766],
                  [73.78025401234572, 25.493331699418768],
                  [73.7649761497969, 25.476906128005062],
                  [73.79467356800978, 25.466522769689632]]]),
            {
              "farm": 0,
              "system:index": "7"
            })]);
var farms2 = /* color: #98ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.65423750463844, 28.173073591987475],
                  [72.65396928373696, 28.17447332862262],
                  [72.65246724668862, 28.174312548994248],
                  [72.65261745039345, 28.172931725765775]]]),
            {
              "farm": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.63827893558664, 28.17166199256161],
                  [72.63853642765207, 28.169808234640392],
                  [72.64049980465097, 28.169921730946374],
                  [72.64042470279855, 28.171794402612626]]]),
            {
              "farm": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.51110068067635, 26.483219202379804],
                  [71.51068762048806, 26.482719844998794],
                  [71.51010289892281, 26.48271024195099],
                  [71.51010289892281, 26.482066835921252],
                  [71.51111140951241, 26.482129256066866],
                  [71.51108458742226, 26.482388539386054],
                  [71.51143863901223, 26.482326119381174],
                  [71.51174977525795, 26.482969523960346]]]),
            {
              "farm": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.16331723933718, 25.698700289570045],
                  [72.16213706737062, 25.69723080329859],
                  [72.16134313350221, 25.696728080147427],
                  [72.16093543773195, 25.69686342889693],
                  [72.16022733455202, 25.696090005398865],
                  [72.16104272609255, 25.694910524892112],
                  [72.16012004619142, 25.69380837681054],
                  [72.16127876048586, 25.69289958036825],
                  [72.16250184779665, 25.694678494564755],
                  [72.16393951182863, 25.694910524892112],
                  [72.1650338531067, 25.69610934104753],
                  [72.16460469966432, 25.697114790452105],
                  [72.16496948009035, 25.697540170336612]]]),
            {
              "farm": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.16060414418405, 25.54502203281892],
                  [72.16136589154428, 25.54614491418567],
                  [72.1617306719703, 25.546493392471227],
                  [72.16068997487253, 25.547190346003152],
                  [72.16007843121713, 25.546745070602967],
                  [72.15916648015207, 25.54586419483004],
                  [72.16005697354501, 25.545496354679344]]]),
            {
              "farm": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[74.21347898797387, 28.32751707900355],
                  [74.215302890104, 28.32825371260598],
                  [74.21386522607202, 28.32994417298139],
                  [74.21257776574487, 28.329519199439453]]]),
            {
              "farm": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[74.22006125703274, 28.320944470560377],
                  [74.2214238192123, 28.322814492281395],
                  [74.22201390519558, 28.323296159215385],
                  [74.22148819222866, 28.323853379024094],
                  [74.22051186814724, 28.323570047282978],
                  [74.21931023850857, 28.322578380242142],
                  [74.21885962739407, 28.321955041938885]]]),
            {
              "farm": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.64875951215424, 29.090963923821686],
                  [73.64504733487763, 29.090007630446546],
                  [73.64729895735195, 29.086559904872953],
                  [73.64905848646572, 29.08768499264458],
                  [73.65210547590664, 29.08824753192155],
                  [73.65242734098842, 29.091660204337146]]]),
            {
              "farm": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[74.17987476260464, 29.090554167595386],
                  [74.1798854914407, 29.088688442309945],
                  [74.18382297427456, 29.088829076047006],
                  [74.18395172030728, 29.09061042009414]]]),
            {
              "farm": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[74.24533980689773, 29.04024733455312],
                  [74.24516814552078, 29.041851301299282],
                  [74.24320476852188, 29.04180440204067],
                  [74.2431725820137, 29.04015353455656]]]),
            {
              "farm": 1,
              "system:index": "9"
            })]);



////// Note while name is "testing" training/testing split done in classifier

var testing_farms = /* color: #0b4a8b */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.61565814810024, 26.968490828636103],
                  [72.61419902639614, 26.96734336597567],
                  [72.6152182658218, 26.96647319899601],
                  [72.6167310317062, 26.967897974388197]]]),
            {
              "farm": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.62677221132901, 26.91745311433044],
                  [72.6280489428201, 26.918658483166173],
                  [72.62684731318143, 26.919414223726402],
                  [72.62554912401822, 26.918735014086135]]]),
            {
              "farm": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.30529302106493, 26.82998926961139],
                  [72.30356567845934, 26.828648919369822],
                  [72.3059903954088, 26.826389435921154],
                  [72.30769628034227, 26.827720238830604]]]),
            {
              "farm": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.31196831110105, 26.90085222106793],
                  [71.3119039380847, 26.899158694089532],
                  [71.31404970529661, 26.899091717924293],
                  [71.31408189180479, 26.900928764060335]]]),
            {
              "farm": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.41638769726092, 27.805777440906702],
                  [72.41422047237688, 27.804278007453995],
                  [72.41194595913225, 27.805511720031333],
                  [72.41286863903338, 27.80663153931863],
                  [72.4123321972304, 27.80716297494171],
                  [72.41128077129656, 27.806213980933915],
                  [72.40973581890398, 27.807409712025876],
                  [72.40814795116717, 27.80558764034775],
                  [72.41044392208391, 27.804050243600194],
                  [72.41441359142596, 27.802304038192386],
                  [72.41743912319475, 27.80553070011541]]]),
            {
              "farm": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.26184017721039, 27.903493501281435],
                  [72.26181871953827, 27.90462179038033],
                  [72.26103551450592, 27.90466445654396],
                  [72.26101942125183, 27.90346031612982]]]),
            {
              "farm": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.18188791923308, 27.86422469942159],
                  [72.1819093769052, 27.864883898619894],
                  [72.18075066261076, 27.864912353171267],
                  [72.18062728099608, 27.864248411692476]]]),
            {
              "farm": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.05396025091989, 25.334663559709373],
                  [72.05624549300057, 25.336884147242735],
                  [72.05501167685372, 25.337882913502707],
                  [72.0525225868879, 25.335788403901756]]]),
            {
              "farm": 1,
              "system:index": "7"
            })]);
var testing_notfarms = ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[72.6188062204742, 26.969865036960467],
                  [72.61736855644222, 26.968583718532233],
                  [72.61932120460506, 26.966174035428136],
                  [72.61994347709651, 26.969635548164614]]]),
            {
              "farm": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.61754932654662, 26.923329812295],
                  [72.6155108476953, 26.922315814685316],
                  [72.61791410697265, 26.920326057040956],
                  [72.61948051703735, 26.92222015406302]]]),
            {
              "farm": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.30224787997099, 26.829081069618493],
                  [72.30546653078886, 26.831283056811852],
                  [72.30351388262602, 26.833274382283925],
                  [72.30044543551298, 26.83164685927138]]]),
            {
              "farm": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.21722302965895, 26.952552101764535],
                  [71.21958337359206, 26.954244827356053],
                  [71.21959410242812, 26.955880148267173],
                  [71.21853194765822, 26.955889711477546],
                  [71.21827445559279, 26.95430220743895],
                  [71.21655784182326, 26.95321198086699]]]),
            {
              "farm": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.40348612558728, 27.804457041138992],
                  [72.40839993250256, 27.809296902179238],
                  [72.40404402506238, 27.81140359786258],
                  [72.3995808292616, 27.810207910731993],
                  [72.39786421549206, 27.807285064559792]]]),
            {
              "farm": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.30293451762009, 27.811858810379018],
                  [72.30585276102829, 27.81406034937586],
                  [72.30108915781784, 27.81823555937857],
                  [72.29804216837692, 27.816337756549732]]]),
            {
              "farm": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[72.15354273478931, 27.844487026819767],
                  [72.1494872347588, 27.8480159980897],
                  [72.1469123141045, 27.84646022920891],
                  [72.1531994120354, 27.843519385607237]]]),
            {
              "farm": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.33647441439189, 25.766411379047167],
                  [71.32866382174052, 25.76208267562204],
                  [71.33759021334208, 25.753965931304762],
                  [71.34316920809306, 25.76022746869385]]]),
            {
              "farm": 0,
              "system:index": "7"
            })]);

var farm_final = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[73.26368374181902, 26.966112531945708],
                  [73.26771778417742, 26.969019446415494],
                  [73.2661299164406, 26.970205139980635],
                  [73.26625866247332, 26.97139082105971],
                  [73.26441330267107, 26.972499995281268],
                  [73.26093715978777, 26.968636961956832]]]),
            {
              "farm": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.2559449002132, 26.94781598088336],
                  [73.25704997032733, 26.950235620392196],
                  [73.25497930496783, 26.95019736562628],
                  [73.25494711845965, 26.947911619794706]]]),
            {
              "farm": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.27555721253009, 26.95987540739559],
                  [73.27542846649737, 26.962399977213437],
                  [73.27400153130145, 26.96238085189722],
                  [73.27405517548175, 26.959722401345644]]]),
            {
              "farm": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.2143170372849, 26.95254788205147],
                  [73.21785755318456, 26.954307551136093],
                  [73.21726746720128, 26.95514912228806],
                  [73.21645207566075, 26.954757027419827],
                  [73.215776158989, 26.955713353972147],
                  [73.21252532166295, 26.953877199822486],
                  [73.21290083092504, 26.952968674984778],
                  [73.21402735871129, 26.95347553711345]]]),
            {
              "farm": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.21960635346227, 26.95216534165756],
                  [73.21883387726598, 26.953131253651797],
                  [73.21663446587377, 26.95183061774757],
                  [73.21776099366002, 26.950539530495195]]]),
            {
              "farm": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[73.20747337284047, 26.95372837323991],
                  [73.20607862415272, 26.956205264910064],
                  [73.20290288867909, 26.954933354367444],
                  [73.20348224582631, 26.953804880361282],
                  [73.20567092838246, 26.95459863868023],
                  [73.20635757389027, 26.953470161321686]]]),
            {
              "farm": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.01615602958987, 26.86077031795873],
                  [71.01813013542483, 26.862416564555904],
                  [71.01703579414675, 26.863067399625802],
                  [71.01544792640993, 26.861287165400658]]]),
            {
              "farm": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.21950548171264, 26.89132018445269],
                  [71.22032087325317, 26.89208567663836],
                  [71.21808927535278, 26.893846288981383],
                  [71.21742408751709, 26.893463549501796]]]),
            {
              "farm": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.31410919195696, 26.899179881851445],
                  [71.31408773428484, 26.90072989028849],
                  [71.31217800146624, 26.90082556912452],
                  [71.312135086122, 26.899218153920852]]]),
            {
              "farm": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.30363695104813, 26.92761795575749],
                  [71.30566470106339, 26.928899740025663],
                  [71.30423776586747, 26.930382382764147],
                  [71.30240313490128, 26.929062353406604]]]),
            {
              "farm": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.64876595913825, 26.538013767606017],
                  [71.64965645253119, 26.538944811131312],
                  [71.64870158612189, 26.539482317355127],
                  [71.64663092076239, 26.539405530905913],
                  [71.64649144589362, 26.538570474952078]]]),
            {
              "farm": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.70890102779435, 26.503606360220097],
                  [71.71042452251481, 26.50544979555232],
                  [71.70767794048356, 26.50654432128633],
                  [71.70643339550065, 26.505372986337335]]]),
            {
              "farm": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.67119626918861, 26.480601550963076],
                  [71.67327766338417, 26.482675828702376],
                  [71.67593841472694, 26.484961332148895],
                  [71.67529468456337, 26.485671941610327],
                  [71.67271976390907, 26.48492292070153],
                  [71.67138938823769, 26.483271216328266],
                  [71.66922216335365, 26.481004885675635],
                  [71.67057399669716, 26.479852497030045]]]),
            {
              "farm": 1,
              "system:index": "12"
            })]),
    nf_final = /* color: #98ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[69.8882196266801, 26.436454739933154],
                  [69.87311342550822, 26.409706006512803],
                  [69.94624117209025, 26.37280102411186],
                  [69.96993044210978, 26.41032098960186]]]),
            {
              "farm": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[69.84187105490275, 26.398943271854353],
                  [69.75604036642619, 26.392792687130935],
                  [69.76084688498088, 26.362034849589577],
                  [69.84290102316447, 26.363880550724886]]]),
            {
              "farm": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[71.07899420850276, 27.131705779993954],
                  [71.06526129834651, 27.122080738666543],
                  [71.07238524549007, 27.114670420363314],
                  [71.08843558423519, 27.12910862822665],
                  [71.08019583814144, 27.13544862789519]]]),
            {
              "farm": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[70.88710938002453, 27.31112095079266],
                  [70.88459883238659, 27.30854704514325],
                  [70.88395510222301, 27.305629879899534],
                  [70.88884745146618, 27.305477346273943]]]),
            {
              "farm": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[70.8940492357109, 27.37098850931043],
                  [70.89602334154586, 27.37316080918413],
                  [70.89138848436812, 27.376362015484307],
                  [70.88911397112349, 27.375904705968654],
                  [70.88791234148482, 27.374951971740533],
                  [70.89280469072798, 27.372551045103283]]]),
            {
              "farm": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[70.47072172969206, 27.410123245297914],
                  [70.4742407879196, 27.410808996600817],
                  [70.47213793605192, 27.418809113955962],
                  [70.47728777736052, 27.42398983320372],
                  [70.47308207362516, 27.426219208288636],
                  [70.46887636988981, 27.419667213776233]]]),
            {
              "farm": 0,
              "system:index": "5"
            })]);

//// Combine
////// Note while two names are "testing" training/testing split done in classifier
var farm_polys = farms.merge(farms2).merge(
        testing_farms).merge(
        farm_final) ;

var notfarm_polys = not_farms.merge(
        not_farms2).merge(
        testing_notfarms).merge(nf_final);
// To be added: build out classification and CV scheme

////////////Create good composite in Year x, still train on year 2003//////////
var collection = ee.ImageCollection("LANDSAT/LE07/C01/T1")
  .filterDate('2002-01-01', '2002-05-01')
  .filterBounds(geometry);

// Also filter the collection by the IMAGE_QUALITY property.
var filtered = collection
  .filterMetadata('IMAGE_QUALITY', 'equals', 9);

// Create two composites to check the effect of filtering by IMAGE_QUALITY.
var goodComposite2 = ee.Algorithms.Landsat.simpleComposite(filtered, 75, 3);

// Compute the Normalized Difference Vegetation Index (NDVI).
var nir = goodComposite2.select('B5');
var red = goodComposite2.select('B4');
var ndvi2 = nir.subtract(red).divide(nir.add(red)).rename('NDVI');

// Add PC band
var Panchromatic2 = goodComposite2.select(['B8']);

// Detect edges in the panchromatic composite.
var canny2 = ee.Algorithms.CannyEdgeDetector(Panchromatic2, 12, 2);

// Detect edges in the NDVI composite.
var canny2_1 = ee.Algorithms.CannyEdgeDetector(ndvi2, .1, 5.5);

// Create buffers around NDVi and Pan bands
var bufferSize = 80 ;// in meters
var edgeBuffer_NDVI2 = canny2_1.focal_max(bufferSize, 'square', 'meters'); 

var bufferSize = 65 ;// in meters
var edgeBuffer_Pan2 = canny2.focal_max(bufferSize, 'square', 'meters'); 




///////////////////////////////////////////


var all_layers= goodComposite.addBands(
  edgeBuffer_NDVI.select(['NDVI'],['eb_ndvi'])).addBands(
    edgeBuffer_Pan.select(['B8'],['eb_pan'])).addBands(
      ndvi);

var all_layers2= goodComposite2.addBands(
  edgeBuffer_NDVI2.select(['NDVI'],['eb_ndvi'])).addBands(
    edgeBuffer_Pan2.select(['B8'],['eb_pan'])).addBands(
      ndvi);


// create image collection for the classifier
var bands =['B1','B2','B3', 'B4','B5','B6_VCID_2','B7','eb_ndvi', 'eb_pan', 'NDVI','B8'];
var farm_points= all_layers.select(bands).sampleRegions({
  collection:farm_polys,
  properties:['farm'],
  scale:30
});

var nf_points= all_layers.select(bands).sampleRegions({
  collection:notfarm_polys,
  properties:['farm'],
  scale:30
});

var all_points = nf_points.randomColumn('x',12412).filter(ee.Filter.lte('x',0.02)).merge(farm_points);

// Make a Random Forest classifier and train on all points. (3 trees, 4 min leaf size)
var classifier = ee.Classifier.randomForest(6,0,5).train({
  features: all_points,
  classProperty: 'farm',
  inputProperties: bands
});

// Classify the input imagery.
var classified = all_layers2.select(bands).classify(classifier);

//For counting the number of correctly classified pixels within districts
//To be added: district shape file importing
/////////////

//Add in pre-loaded table ()
var namelist = ['Bharatpur' ,'Karauli', 'Dhalpur', 'Sawai Madhopur','Bundi', 'Tonk', 'Kota', 'Jhalawar', 'Chittaurgarh', 'Udaipur','Dungarpur', 'Baran','Pratapgarh' , 'Banswara', 'Rajsamand', 'Sirohi','Dhaulpur', 'Dausa', 'Alwar'];
var rajDist = ee.FeatureCollection("users/mrh2182/DISTRICT_11").filter(ee.Filter.eq('STATE_UT','Rajasthan')).filter(
  ee.Filter.inList('DISTRICT',namelist).not());
  
var classified_mask = classified.updateMask(classified);


// Define a palette for the Land Use classification.
var palette = [
  '0000FF', // not farm (0)  // blue
  '008000' //  farm (1) // green
];

//Adding visuals
//Map.addLayer(classified_mask, {min: 0, max: 1, palette: palette}, 'Land Use Classification');

var pixPerDist = classified_mask.reduceRegions({
  collection: rajDist,
  reducer: ee.Reducer.sum(),
  scale: 30,
});

Export.table.toDrive({
  collection: pixPerDist,
  description: 'pixPerDist_2002',
  fileFormat: 'CSV'
});
